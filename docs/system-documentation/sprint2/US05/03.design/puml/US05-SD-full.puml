@startuml US05-SD
'skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

'hide footbox
actor "Player" as PLAYER
participant ":BuildStationUI" as UI
participant ":BuildStationController" as CTRL
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant "mapRepository\n:MapRepository" as MAP_REPO
participant "currentMap\n:Map" as CURRENT_MAP
participant "ApplicationSession" as APP_SESSION
participant "appSession\n:ApplicationSession" as APP_SESSION_SINGLETON
participant "currentSession\n:UserSession" as CURRENT_SESSION
participant "stationRepository\n:StationRepository" as STATION_REPO
participant "station\n:Station" as STATION

activate PLAYER

    PLAYER -> UI : asks to build a station
    activate UI
        UI --> CTRL** : create()

        UI -> CTRL : getStationTypes()
        activate CTRL
            CTRL --> UI : stationTypes (depot, station, terminal)
        deactivate CTRL

        UI --> PLAYER : shows station types and asks to select one
    deactivate UI

    PLAYER -> UI : selects a station type
    activate UI
        UI -> CTRL : getCurrentMap()
        activate CTRL
            CTRL -> REPOS : getInstance()
            activate REPOS
                REPOS --> CTRL: repositories
            deactivate REPOS

            CTRL -> REPOS_SINGLETON : getMapRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL: mapRepository
            deactivate REPOS_SINGLETON

            CTRL -> MAP_REPO : getCurrentMap()
            activate MAP_REPO
                MAP_REPO --> CTRL : currentMap
            deactivate MAP_REPO

            CTRL --> UI : currentMap
        deactivate CTRL

        UI --> PLAYER : requests position (X,Y coordinates)
    deactivate UI

    PLAYER -> UI : inputs position (X,Y)
    activate UI
        UI -> CTRL : validatePosition(x, y, stationType)
        activate CTRL
            CTRL -> CURRENT_MAP : validateStationPosition(x, y, stationType)
            activate CURRENT_MAP
                CURRENT_MAP --> CTRL : isValid (boolean)
            deactivate CURRENT_MAP

            CTRL --> UI : isValid
        deactivate CTRL


            UI -> CTRL : generateStationName(x, y)
            activate CTRL
                CTRL -> CURRENT_MAP : findClosestCity(x, y)
                activate CURRENT_MAP
                    CURRENT_MAP --> CTRL : closestCity
                deactivate CURRENT_MAP

                CTRL --> UI : proposedName (e.g. "Porto Terminal")
            deactivate CTRL

            UI --> PLAYER : shows proposed name and asks for confirmation



    deactivate UI

    PLAYER -> UI : confirms name
    activate UI
        UI -> CTRL : buildStation(x, y, stationType, stationName)
        activate CTRL
            CTRL -> APP_SESSION : getInstance()
            activate APP_SESSION
                APP_SESSION --> CTRL : appSession
            deactivate APP_SESSION

            CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
            activate APP_SESSION_SINGLETON
                APP_SESSION_SINGLETON --> CTRL : currentSession
            deactivate APP_SESSION_SINGLETON

            CTRL -> CURRENT_SESSION : getPlayer()
            activate CURRENT_SESSION
                CURRENT_SESSION --> CTRL : player
            deactivate CURRENT_SESSION

            CTRL -> CTRL : calculateStationCost(stationType)
            activate CTRL
                CTRL --> CTRL : cost
            deactivate CTRL

            CTRL -> REPOS : getInstance()
            activate REPOS
                REPOS --> CTRL : repositories
            deactivate REPOS

            CTRL -> REPOS_SINGLETON : getStationRepository()
            activate REPOS_SINGLETON
                REPOS_SINGLETON --> CTRL : stationRepository
            deactivate REPOS_SINGLETON

            CTRL --> STATION** : create(x, y, stationName, stationType, currentMap)

            CTRL -> STATION_REPO : addStation(station)
            activate STATION_REPO
                STATION_REPO --> CTRL : success
            deactivate STATION_REPO

            CTRL -> CURRENT_SESSION : updateBudget(-cost)
            activate CURRENT_SESSION
                CURRENT_SESSION --> CTRL : newBudget
            deactivate CURRENT_SESSION

            CTRL --> UI : station
        deactivate CTRL

        UI --> PLAYER : displays operation success
    deactivate UI

deactivate PLAYER
@enduml