@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

participant ":UpgradeStationController" as CTRL
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant "stationRepository\n:StationRepository" as STATION_REPO
participant "ApplicationSession" as APP_SESSION
participant "appSession\n:ApplicationSession" as APP_SESSION_SINGLETON
participant "currentSession\n:UserSession" as CURRENT_SESSION
participant "buildingUpgradeRepository\n:BuildingUpgradeRepository" as BUILDING_REPO
participant "station\n:Station" as STATION
participant "buildingUpgrade\n:BuildingUpgrade" as BUILDING

autonumber 11
-> CTRL : applyUpgrade(stationId, upgradeId)

autonumber 11.1
activate CTRL
    group Apply Upgrade
        CTRL -> REPOS : getInstance()
        activate REPOS
            REPOS --> CTRL: repositories
        deactivate REPOS

        CTRL -> REPOS_SINGLETON : getStationRepository()
        activate REPOS_SINGLETON
            REPOS_SINGLETON --> CTRL: stationRepository
        deactivate REPOS_SINGLETON

        CTRL -> STATION_REPO : getStationById(stationId)
        activate STATION_REPO
            STATION_REPO --> CTRL : station
        deactivate STATION_REPO

        CTRL -> REPOS : getInstance()
        activate REPOS
            REPOS --> CTRL: repositories
        deactivate REPOS

        CTRL -> REPOS_SINGLETON : getBuildingUpgradeRepository()
        activate REPOS_SINGLETON
            REPOS_SINGLETON --> CTRL: buildingUpgradeRepository
        deactivate REPOS_SINGLETON

        CTRL -> BUILDING_REPO : getUpgradeById(upgradeId)
        activate BUILDING_REPO
            BUILDING_REPO --> CTRL : buildingUpgrade
        deactivate BUILDING_REPO

        CTRL -> CTRL : validateUpgradeCompatibility(station, buildingUpgrade)
        activate CTRL
            CTRL --> CTRL : isCompatible (boolean)
        deactivate CTRL


            CTRL -> STATION : addUpgrade(buildingUpgrade)

            ref over STATION
                Validate and Add Upgrade
            end ref

            STATION --> CTRL : success


                CTRL -> APP_SESSION : getInstance()
                activate APP_SESSION
                    APP_SESSION --> CTRL : appSession
                deactivate APP_SESSION

                CTRL -> APP_SESSION_SINGLETON : getCurrentSession()
                activate APP_SESSION_SINGLETON
                    APP_SESSION_SINGLETON --> CTRL : currentSession
                deactivate APP_SESSION_SINGLETON

                CTRL -> BUILDING : getCost()
                activate BUILDING
                    BUILDING --> CTRL : cost
                deactivate BUILDING

                CTRL -> CURRENT_SESSION : updateBudget(-cost)
                activate CURRENT_SESSION
                    CURRENT_SESSION --> CTRL : newBudget
                deactivate CURRENT_SESSION

                CTRL -> STATION_REPO : updateStation(station)
                activate STATION_REPO
                    STATION_REPO --> CTRL : success
                deactivate STATION_REPO



    end
    autonumber 12
    <-- CTRL : success
deactivate CTRL
@enduml